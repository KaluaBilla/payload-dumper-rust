name: macOS Builds

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        architecture: [x86_64, arm64]
      fail-fast: false

    runs-on: macos-14
    steps:
      - uses: actions/checkout@v3

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Set target
        id: set-target
        run: |
          case "${{ matrix.architecture }}" in
            x86_64)
              echo "TARGET=x86_64-apple-darwin" >> $GITHUB_ENV
              ;;
            arm64)
              echo "TARGET=aarch64-apple-darwin" >> $GITHUB_ENV
              ;;
          esac
          
      - name: Add Rust target
        run: |
          if [ "${{ matrix.architecture }}" = "x86_64" ]; then
            rustup target add x86_64-apple-darwin
          else
            rustup target add aarch64-apple-darwin
          fi

      - name: Build for ${{ matrix.architecture }}
        run: |
          cargo build --release --target $TARGET --features differential_ota

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Copy binaries
        run: |
          # Determine correct target directory based on architecture
          if [ "${{ matrix.architecture }}" = "arm64" ]; then
            TARGET_DIR="aarch64-apple-darwin"
          else
            TARGET_DIR="x86_64-apple-darwin"
          fi
          
          # Find and copy binary
          echo "Looking for binary in target/$TARGET_DIR/release/"
          ls -la target/$TARGET_DIR/release/ || echo "Release directory not found"
          
          cp target/$TARGET_DIR/release/payload_dumper ./artifacts/payload_dumper-${{ matrix.architecture }} || echo "Binary not found"
          
          # Make it executable and verify architecture
          if [ -f ./artifacts/payload_dumper-${{ matrix.architecture }} ]; then
            chmod +x ./artifacts/payload_dumper-${{ matrix.architecture }}
            echo "Binary architecture:"
            file ./artifacts/payload_dumper-${{ matrix.architecture }}
          else
            echo "Failed to find binary"
            find target -type f -executable | grep -v '\.so' | sort
          fi

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: payload_dumper-${{ matrix.architecture }}-darwin
          path: artifacts/payload_dumper-${{ matrix.architecture }}
          if-no-files-found: warn

  create-universal-binary:
    needs: build
    runs-on: macos-14
    steps:
      - name: Download x86_64 binary
        uses: actions/download-artifact@v4
        with:
          name: payload_dumper-x86_64-darwin
          path: binaries

      - name: Download arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: payload_dumper-arm64-darwin
          path: binaries

      - name: Check binaries
        run: |
          ls -la binaries/
          file binaries/payload_dumper-x86_64 || echo "x86_64 binary not found or not executable"
          file binaries/payload_dumper-arm64 || echo "arm64 binary not found or not executable"

      - name: Create universal binary
        run: |
          mkdir -p universal
          lipo -create -output universal/payload_dumper binaries/payload_dumper-x86_64 binaries/payload_dumper-arm64
          chmod +x universal/payload_dumper
          file universal/payload_dumper

      - name: Upload Universal Binary
        uses: actions/upload-artifact@v4
        with:
          name: payload_dumper-universal-darwin
          path: universal/payload_dumper
          if-no-files-found: error
